<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BABEL MASTER - Zizo Legend</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-body: #050508;
            --bg-panel: #0e1016;
            --primary: #00f2ff;
            --secondary: #7d5fff;
            --text-main: #e0e6ed;
            --border: rgba(255, 255, 255, 0.1);
            --error: #ff4757;
            --success: #00ff9d;
            /* ÙØµÙ„Ù†Ø§ Ø§Ù„Ø®ØµØ§Ø¦Øµ Ø¹Ø´Ø§Ù† Ø§Ù„Ù…ØªØµÙØ­ Ù…Ø§ ÙŠØ®Ø±Ø¨Ø· Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨ */
            --font-family: 'Fira Code', monospace;
            --font-size: 14px;
            --line-height: 24px;
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; height: 100dvh; background: var(--bg-body); color: var(--text-main); font-family: 'Tajawal', sans-serif; display: flex; flex-direction: column; overflow: hidden; }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± --- */
        header { 
            height: 60px; background: var(--bg-panel); border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 10px; flex-shrink: 0; z-index: 1000; position: relative;
        }

        .header-right { display: flex; align-items: center; gap: 10px; }
        .logo { font-size: 18px; font-weight: 900; background: linear-gradient(90deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; letter-spacing: 1px; }
        
        #kingBadge {
            color: #ffd700; font-size: 18px; cursor: pointer; padding: 5px;
            animation: glow 2s infinite alternate;
        }
        @keyframes glow { from { text-shadow: 0 0 5px #ffd700; } to { text-shadow: 0 0 15px #ffaa00; } }

        .header-left { display: flex; align-items: center; gap: 6px; }

        .credits-pill {
            background: rgba(0, 242, 255, 0.05); border: 1px solid var(--border);
            padding: 0 10px; border-radius: 6px; color: var(--primary); font-family: 'Fira Code';
            font-size: 12px; display: flex; align-items: center; gap: 5px; height: 36px;
        }

        .icon-btn { 
            width: 36px; height: 36px; border-radius: 6px; 
            background: rgba(255,255,255,0.03); 
            border: 1px solid var(--border); color: #fff; display: flex; 
            align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; 
        }
        .icon-btn:hover { border-color: var(--primary); color: var(--primary); }

        /* --- Ø§Ù„Ù…Ø­Ø±Ø± --- */
        .workspace { flex: 1; display: flex; flex-direction: column; min-height: 0; position: relative; }
        .editor-container { flex: 1; display: flex; background: #080a10; direction: ltr; overflow: hidden; position: relative; }
        .gutter { width: 40px; background: #0c0e14; color: #4b5263; text-align: center; padding-top: 15px; font-family: var(--font-family); font-size: var(--font-size); line-height: var(--line-height); border-right: 1px solid var(--border); user-select: none; }
        
        .editor-wrapper { flex: 1; position: relative; cursor: text; overflow: hidden; }
        
        /* Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ: Ù…Ù†Ø¹Ù†Ø§ Ø§Ù„Ø­ÙˆØ§Ù Ø§Ù„ØºØ±ÙŠØ¨Ø© ÙˆÙˆØ­Ø¯Ù†Ø§ Ø§Ù„Ø®Ø· */
        .editor-layer { 
            position: absolute; inset: 0; padding: 15px; margin: 0; border: 0; 
            font-family: var(--font-family); 
            font-size: var(--font-size);
            line-height: var(--line-height);
            white-space: pre; 
            tab-size: 4; 
            overflow: auto; 
            word-wrap: normal;
            font-variant-ligatures: none; /* Ù‡Ø§ÙŠ ØªÙ…Ù†Ø¹ Ø§Ù„Ù†Øµ ÙŠØªØºÙŠØ± Ø­Ø¬Ù…Ù‡ Ù„Ù…Ø§ ÙŠÙ†ÙƒØªØ¨ Ø±Ù…ÙˆØ² */
            letter-spacing: normal;
        }
        
        /* Ø·Ø¨Ù‚Ø© Ø§Ù„ØªÙ„ÙˆÙŠÙ† */
        #highlighting { 
            z-index: 1; 
            pointer-events: none; 
            color: #abb2bf; 
        }
        
        /* Ø·Ø¨Ù‚Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© */
        #codeEditor { 
            background: transparent; 
            color: transparent; /* Ø§Ù„Ù†Øµ Ø´ÙØ§Ù Ø¹Ø´Ø§Ù† Ù†Ø´ÙˆÙ Ø§Ù„Ù„ÙŠ ØªØ­ØªÙ‡ */
            caret-color: var(--primary); 
            z-index: 2; 
            resize: none; 
        }

        /* Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ - ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ */
        #autocomplete { 
            position: absolute; 
            background: #15171e; 
            border: 1px solid var(--secondary); 
            display: none; 
            z-index: 500; 
            border-radius: 6px; 
            max-height: 150px; 
            overflow-y: auto; 
            min-width: 150px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5); 
            /* Ø´Ù„Ù†Ø§ Ø§Ù„ØªÙˆØ¨ ÙˆØ§Ù„Ù„ÙØª Ø§Ù„Ø«Ø§Ø¨ØªØ§Øª */
        }
        .auto-item { padding: 8px 12px; cursor: pointer; color: #a0a0a0; font-family: 'Fira Code'; font-size: 13px; border-bottom: 1px solid rgba(255,255,255,0.05); text-align: left; }
        .auto-item:hover, .auto-item.active { background: rgba(125, 95, 255, 0.2); color: var(--secondary); }
        .auto-item strong { color: var(--primary); }

        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª */
        .shortcut-bar { 
            height: 45px; background: var(--bg-panel); border-top: 1px solid var(--border); 
            display: flex; align-items: center; gap: 8px; padding: 0 10px; overflow-x: auto; 
        }
        .sc-key { 
            min-width: 35px; height: 32px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); 
            border-radius: 4px; color: var(--text-main); display: flex; align-items: center; justify-content: center; 
            font-family: 'Fira Code'; font-size: 14px; cursor: pointer; flex-shrink: 0;
        }

        /* Ø§Ù„ØªÙŠØ±Ù…Ù†Ø§Ù„ */
        #termView { position: fixed; inset: 0; background: #050508; display: none; flex-direction: column; direction: ltr; z-index: 9000; }
        .term-header { padding: 15px; background: #0b0d14; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        #consoleOutput { flex: 1; padding: 20px; font-family: 'Fira Code'; overflow-y: auto; color: #00ff9d; font-size: 14px; }

        /* Ø£Ù„ÙˆØ§Ù† Syntax */
        .tok-kwd { color: #ff79c6; font-weight: bold; } 
        .tok-str { color: #f1fa8c; } 
        .tok-num { color: #bd93f9; } 
        .tok-var { color: #8be9fd; } 
        .tok-cmt { color: #6272a4; font-style: italic; }
        .tok-sym { color: #ffb86c; }

    </style>
</head>
<body>

<header>
    <div class="header-right">
        <div class="logo">BABEL MASTER</div>
        <div id="kingBadge" onclick="window.location.href='seibond.html'" title="Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©">
            <i class="fas fa-crown"></i>
        </div>
    </div>

    <div class="header-left">
        <div class="icon-btn" onclick="window.location.href='drdsha.html'" title="Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©">
            <i class="fas fa-comments"></i>
        </div>
        <div class="icon-btn" onclick="window.location.href='profile.html'" title="Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ">
            <i class="fas fa-user-astronaut"></i>
        </div>
        <div class="credits-pill">
            <i class="fas fa-coins"></i>
            <span id="creditsDisplay">0</span>
        </div>
        <div class="icon-btn" onclick="runBabylon()" title="ØªØ´ØºÙŠÙ„" style="border-color:var(--success); color:var(--success)">
            <i class="fas fa-play"></i>
        </div>
    </div>
</header>

<div class="workspace">
    <div id="autocomplete"></div>
    <div class="editor-container">
        <div class="gutter" id="lineNumbers">1</div>
        <div class="editor-wrapper">
            <pre id="highlighting" class="editor-layer"></pre>
            <textarea id="codeEditor" class="editor-layer" spellcheck="false" placeholder="// Ø§ÙƒØªØ¨ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§ ÙŠØ§ Ø£Ø³Ø·ÙˆØ±Ø©..."></textarea>
        </div>
    </div>

    <div class="shortcut-bar">
        <div class="sc-key" onclick="insertCode('say ')">say</div>
        <div class="sc-key" onclick="insertCode('var ')">var</div>
        <div class="sc-key" onclick="insertCode('if ()')">if</div>
        <div class="sc-key" onclick="insertCode('{}')">{ }</div>
        <div class="sc-key" onclick="insertCode('()')">( )</div>
        <div class="sc-key" onclick="insertCode('=')">=</div>
        <div class="sc-key" onclick="insertCode(';')">;</div>
        <div class="sc-key" onclick="insertCode('$')">$</div>
        <div class="sc-key" onclick="insertCode('Â«Â»')"></div>
    </div>
</div>

<div id="termView">
    <div class="term-header">
        <span style="color:var(--primary); font-weight:bold;"><i class="fas fa-terminal"></i> BABYLON CONSOLE</span>
        <i class="fas fa-times" onclick="document.getElementById('termView').style.display='none'" style="cursor:pointer; color:var(--error); font-size: 20px;"></i>
    </div>
    <div id="consoleOutput"></div>
</div>

<script src="bavault.js"></script>
<script src="basisst.js"></script>
<script src="interpreter.js"></script>
<script src="bacore2t.js"></script>
<script src="cyber_tools.js"></script>
<script src="cyber_engine.js"></script>
<script src="babylon_is_heavy.js"></script>
<script src="babylon_core.js"></script>

<script>
// --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø±Ø± ---
const editor = document.getElementById('codeEditor');
const highlighting = document.getElementById('highlighting');
const gutter = document.getElementById('lineNumbers');
const autoPopup = document.getElementById('autocomplete');
const creditsDisplay = document.getElementById('creditsDisplay');

// Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©
const KEYWORDS = ['say', 'ask', 'var', 'loop', 'if', 'else', 'wait', 'check', 'calc', 'random', 'grab', 'ping', 'clear', 'login', 'connect'];

// Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ„ÙˆÙŠÙ†
function syncEditor() {
    let code = editor.value;
    
    // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø±Ù…ÙˆØ² Ù„Ø·Ø¨Ù‚Ø© Ø§Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·
    let html = code
        .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
        .replace(/"(.*?)"/g, '<span class="tok-str">"$1"</span>')
        .replace(/\b(say|ask|var|loop|if|else|wait|check|calc|random|grab|ping|clear|login|connect)\b/g, '<span class="tok-kwd">$1</span>')
        .replace(/\$(\w+)/g, '<span class="tok-var">$$$1</span>')
        .replace(/\b(\d+)\b/g, '<span class="tok-num">$1</span>')
        .replace(/(=|\+|\-|\*|\/|\{|\}|\(|\)|;)/g, '<span class="tok-sym">$1</span>')
        .replace(/(\/\/.*)/g, '<span class="tok-cmt">$1</span>');

    // Ù†Ø¶ÙŠÙ ÙØ±Ø§Øº Ø¨Ø§Ù„Ù†Ù‡Ø§ÙŠØ© Ø¹Ø´Ø§Ù† ÙŠØ·Ø§Ø¨Ù‚ Ø§Ù„ØªÙƒØ³Øª Ø§ÙŠØ±ÙŠØ§
    highlighting.innerHTML = html + '<br>'; 
    
    // Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø£Ø³Ø·Ø±
    gutter.innerHTML = Array.from({length: code.split('\n').length}, (_, i) => i + 1).join('<br>');
}

// Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ - Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹
editor.addEventListener('scroll', () => {
    highlighting.scrollTop = editor.scrollTop;
    highlighting.scrollLeft = editor.scrollLeft;
    gutter.scrollTop = editor.scrollTop;
});

editor.addEventListener('input', () => {
    syncEditor();
    checkAutocomplete();
});

// --- Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø§Ù„Ù…Ø¹Ø¯Ù„ ---
function checkAutocomplete() {
    const val = editor.value;
    const end = editor.selectionEnd;
    
    // Ù†Ø£Ø®Ø° Ø§Ù„ÙƒÙ„Ù…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    let start = end;
    while (start > 0 && /[\w]/.test(val[start - 1])) start--;
    const word = val.substring(start, end);

    if (word.length < 1) {
        autoPopup.style.display = 'none';
        return;
    }

    const matches = KEYWORDS.filter(k => k.startsWith(word));
    
    if (matches.length > 0) {
        let html = matches.map(m => 
            `<div class="auto-item" onclick="insertAuto('${m}')"><strong>${word}</strong>${m.substring(word.length)}</div>`
        ).join('');
        
        autoPopup.innerHTML = html;
        autoPopup.style.display = 'block';
        
        // --- Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯ (ØªØ­Øª Ø§Ù„Ù…Ø¤Ø´Ø±) ---
        // Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„Ø®Ø· monospace ÙˆØ§Ù„Ø­Ø¬Ù… Ø«Ø§Ø¨ØªØŒ Ù†ÙƒØ¯Ø± Ù†Ø­Ø³Ø¨ ØªÙ‚Ø±ÙŠØ¨ÙŠ
        const textUpToCaret = val.substring(0, end);
        const lines = textUpToCaret.split('\n');
        const currentLineIndex = lines.length; 
        const currentLineText = lines[lines.length - 1]; // Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø¤Ø´Ø±
        
        // Ø­Ø³Ø§Ø¨Ø§Øª ØªÙ‚Ø±ÙŠØ¨ÙŠØ© (8.4px Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø±ÙØŒ 24px Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø³Ø·Ø±)
        const charWidth = 8.5; 
        const lineHeight = 24;
        const gutterWidth = 40;
        const paddingLeft = 15;
        
        // Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† Ø§Ù„ÙŠØ³Ø§Ø± = Ø¹Ø±Ø¶ Ø§Ù„Ø¬ØªØ± + Ø¨Ø§Ø¯ÙŠÙ†Ø¬ + Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø±ÙˆÙ * Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø±Ù
        // Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ù† ÙÙˆÙ‚ = Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø³Ø·Ø± * Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø³Ø·Ø± - Ø§Ù„Ø³ÙƒØ±ÙˆÙ„
        
        let leftPos = gutterWidth + paddingLeft + (currentLineText.length * charWidth);
        let topPos = (currentLineIndex * lineHeight) - editor.scrollTop + 10; // +10 ØªÙ†Ø²ÙŠÙ„ Ø´ÙˆÙŠØ©

        // Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø´Ø§Ø´Ø© Ø¹Ø´Ø§Ù† Ù…Ø§ ØªØ·Ù„Ø¹ Ø¨Ø±Ø§
        if(leftPos > window.innerWidth - 160) leftPos = window.innerWidth - 160;

        autoPopup.style.left = leftPos + 'px';
        autoPopup.style.top = topPos + 'px';

    } else {
        autoPopup.style.display = 'none';
    }
}

function insertAuto(text) {
    const val = editor.value;
    const end = editor.selectionEnd;
    let start = end;
    while (start > 0 && /[\w]/.test(val[start - 1])) start--;
    
    const before = val.substring(0, start);
    const after = val.substring(end);
    
    editor.value = before + text + " " + after;
    editor.selectionStart = editor.selectionEnd = start + text.length + 1;
    editor.focus();
    
    autoPopup.style.display = 'none';
    syncEditor();
}

function insertCode(text) {
    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    editor.setRangeText(text, start, end, 'end');
    
    if (text === '()' || text === '{}' || text === '""') {
        editor.selectionStart = editor.selectionEnd = start + 1;
    }
    editor.focus();
    syncEditor();
}

async function runBabylon() {
    const termView = document.getElementById('termView');
    const consoleDiv = document.getElementById('consoleOutput');
    termView.style.display = 'flex';
    consoleDiv.innerHTML = `<div style="color:#7d5fff">[SYSTEM] Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù†ÙˆØ§Ø©...</div>`;

    const termInterface = {
        print: (msg, color) => {
            const line = document.createElement('div');
            line.style.color = color || '#00ff9d';
            line.innerHTML = msg;
            consoleDiv.appendChild(line);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
    };

    if (typeof BabylonCore === 'undefined') {
        termInterface.print("ğŸš« Ø®Ø·Ø£ ÙØ§Ø¯Ø­: Ù…Ù„ÙØ§Øª BabylonCore Ù…ÙÙ‚ÙˆØ¯Ø©!", "#ff4757");
        return;
    }

    try {
        await BabylonCore.execute(editor.value, termInterface); 
    } catch (e) {
        termInterface.print(`ğŸ’¥ Ø®Ø·Ø£ Ø¨Ø±Ù…Ø¬ÙŠ: ${e.message}`, "#ff4757");
    }
}

window.onload = () => {
    syncEditor();
    if(localStorage.getItem('babel_credits')) {
        creditsDisplay.innerText = localStorage.getItem('babel_credits');
    }
};
</script>
</body>
</html>
