<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BABEL MASTER</title>
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-body: #050508;
            --bg-panel: #0b0d14;
            --primary: #00f2ff;
            --secondary: #7d5fff;
            --text-main: #e0e6ed;
            --border: rgba(255, 255, 255, 0.08);
            --error: #ff4757;
            --success: #00ff9d;
            --editor-font: 14px/24px 'Fira Code', monospace;
        }

        * { box-sizing: border-box; outline: none; }
        body { margin: 0; height: 100dvh; background: var(--bg-body); color: var(--text-main); font-family: 'Tajawal', sans-serif; display: flex; flex-direction: column; overflow: hidden; }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± --- */
        header { 
            height: 55px; background: var(--bg-panel); border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 15px; flex-shrink: 0; z-index: 100; position: relative;
        }

        .logo { font-size: 18px; font-weight: 900; background: linear-gradient(90deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .toolbar { display: flex; gap: 8px; align-items: center; }

        .icon-btn { 
            width: 36px; height: 36px; border-radius: 6px; background: rgba(255,255,255,0.05); 
            border: 1px solid var(--border); color: var(--primary); display: flex; 
            align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; 
        }
        .icon-btn:hover { background: var(--primary); color: #000; }
        .run-btn { color: var(--success); border-color: rgba(0, 255, 157, 0.3); }

        /* --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© --- */
        .dropdown-menu {
            position: absolute; top: 60px; left: 15px; background: var(--bg-panel); border: 1px solid var(--border); 
            border-radius: 8px; min-width: 220px; display: none; flex-direction: column; z-index: 2000; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); backdrop-filter: blur(15px);
        }
        .dropdown-menu.show { display: flex; }
        
        .menu-header {
            padding: 15px; border-bottom: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.02);
            text-align: center;
        }
        .credits-box {
            background: rgba(0, 0, 0, 0.3); border: 1px solid var(--border);
            padding: 8px; border-radius: 6px; color: gold; font-family: 'Fira Code';
            display: flex; justify-content: space-between; align-items: center;
        }

        .dropdown-item { padding: 12px 15px; color: var(--text-main); cursor: pointer; border-bottom: 1px solid var(--border); font-size: 14px; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .dropdown-item:hover { background: rgba(0, 242, 255, 0.1); color: var(--primary); }
        .dropdown-item:last-child { border-bottom: none; }

        /* --- Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„Ù…Ø­Ø±Ø± --- */
        .workspace { flex: 1; display: flex; flex-direction: column; min-height: 0; position: relative; }
        .editor-container { flex: 1; display: flex; background: #080a10; direction: ltr; overflow: hidden; position: relative; }
        
        .gutter { 
            width: 40px; background: #0c0e14; color: #4b5263; text-align: center; 
            padding-top: 15px; font: var(--editor-font); border-right: 1px solid var(--border); 
            user-select: none; line-height: 24px;
        }
        
        .editor-wrapper { flex: 1; position: relative; overflow: hidden; }
        
        /* Ø¶Ø¨Ø· Ø§Ù„Ø·Ø¨Ù‚Ø§Øª Ø¨Ø¯Ù‚Ø© Ø¹Ø´Ø§Ù† Ø§Ù„Ù…Ø¤Ø´Ø± ÙˆØ§Ù„Ø³ÙƒØ±ÙˆÙ„ */
        .editor-layer { 
            position: absolute; inset: 0; padding: 15px; margin: 0; border: 0;
            font: var(--editor-font); white-space: pre; line-height: 24px; tab-size: 4; 
            word-wrap: normal; overflow: auto;
        }
        
        #codeEditor { 
            background: transparent; color: transparent; z-index: 2; 
            resize: none; caret-color: var(--primary); 
        }
        #highlighting { z-index: 1; pointer-events: none; color: #abb2bf; }

        /* --- Ø´Ø±ÙŠØ· Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª --- */
        .shortcut-bar { 
            height: 45px; background: var(--bg-panel); border-top: 1px solid var(--border);
            display: flex; align-items: center; gap: 5px; padding: 0 10px; overflow-x: auto;
        }
        .sc-key {
            min-width: 35px; height: 32px; background: rgba(255,255,255,0.05);
            border: 1px solid var(--border); border-radius: 4px; color: var(--primary);
            display: flex; align-items: center; justify-content: center;
            font-family: 'Fira Code'; font-size: 14px; cursor: pointer; user-select: none;
        }
        .sc-key:hover { background: var(--primary); color: #000; }

        /* --- Ø§Ù„ØªÙŠØ±Ù…Ù†Ø§Ù„ --- */
        #termView { 
            height: 160px; background: #050508; border-top: 2px solid var(--primary); 
            display: none; flex-direction: column; direction: ltr; z-index: 150;
        }
        .term-header { padding: 5px 10px; background: var(--bg-panel); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        #consoleOutput { flex: 1; padding: 10px; font-family: 'Fira Code'; font-size: 12px; overflow-y: auto; white-space: pre-wrap; color: #00ff9d; }

        /* --- Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„ØªØ¹Ø±ÙŠÙ --- */
        #identityGate { position: fixed; inset: 0; background: var(--bg-body); z-index: 9999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .gate-card { background: var(--bg-panel); padding: 40px; border-radius: 15px; border: 1px solid var(--primary); text-align: center; width: 90%; max-width: 380px; box-shadow: 0 0 40px rgba(0, 242, 255, 0.1); }
        .gate-card input { width: 100%; padding: 12px; background: #000; border: 1px solid var(--border); border-radius: 8px; color: #fff; text-align: center; margin-bottom: 15px; font-size: 16px; }
        .gate-card button { width: 100%; padding: 12px; background: var(--primary); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-family: 'Tajawal'; }

        /* --- Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ --- */
        #autocomplete {
            position: absolute; background: #1a1a1a; border: 1px solid var(--primary);
            display: none; z-index: 3000; border-radius: 4px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            max-height: 150px; overflow-y: auto; min-width: 120px;
        }
        .auto-item { padding: 8px 12px; cursor: pointer; color: #fff; font-family: 'Fira Code'; font-size: 13px; text-align: left; }
        .auto-item:hover, .auto-item.active { background: var(--primary); color: #000; }

        /* Syntax Colors */
        .tok-kwd { color: #ff79c6; font-weight: bold; } 
        .tok-str { color: #f1fa8c; } 
        .tok-num { color: #bd93f9; } 
        .tok-var { color: #8be9fd; }
        .tok-cmt { color: #6272a4; font-style: italic; }

        /* --- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© --- */
        .control-bar {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 10;
        }
        .control-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            color: var(--primary);
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-family: 'Fira Code';
            transition: 0.2s;
        }
        .control-btn:hover {
            background: var(--primary);
            color: #000;
        }
    </style>
</head>
<body>

<div id="autocomplete"></div>

<div id="identityGate">
    <div class="gate-card">
        <div class="logo" style="font-size: 24px; margin-bottom: 20px;">BABYLON ID</div>
        <input type="text" id="idInput" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ø§Ù„Ø¨Ø±Ù…Ø¬ÙŠ..." autocomplete="off">
        <button onclick="unlockGate()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <div id="gateError" style="color:var(--error); font-size:12px; margin-top:10px;"></div>
    </div>
</div>

<header>
    <div class="logo">BABEL MASTER</div>
    <div class="toolbar">
        <div id="kingBadge" style="display:none; color:gold;"><i class="fas fa-crown"></i></div>
        <div class="icon-btn run-btn" id="runBtn" title="ØªØ´ØºÙŠÙ„"><i class="fas fa-play"></i></div>
        <div class="icon-btn" id="menuBtn"><i class="fas fa-bars"></i></div>
    </div>
    
    <div class="dropdown-menu" id="dropdownMenu">
        <div class="menu-header">
            <div class="credits-box">
                <span><i class="fas fa-bolt"></i> Ø§Ù„Ø±ØµÙŠØ¯</span>
                <span id="creditsDisplay">0</span>
            </div>
        </div>
        <div class="dropdown-item" onclick="location.href='profile.html'">
            <i class="fas fa-user-circle"></i> Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
        </div>
        <div class="dropdown-item" onclick="saveCode()">
            <i class="fas fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
        </div>
        <div class="dropdown-item" onclick="buildCode()">
            <i class="fas fa-cube"></i> Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
        </div>
        <div class="dropdown-item" onclick="loadCode()">
            <i class="fas fa-folder-open"></i> ØªØ­Ù…ÙŠÙ„ Ù…Ø´Ø±ÙˆØ¹
        </div>
        <div class="dropdown-item" onclick="clearEditor()">
            <i class="fas fa-trash"></i> Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„
        </div>
        <div class="dropdown-item" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i> Ø®Ø±ÙˆØ¬
        </div>
    </div>
</header>

<div class="workspace">
    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© -->
    <div class="control-bar">
        <button class="control-btn" onclick="undoCode()" title="ØªØ±Ø§Ø¬Ø¹ (Ctrl+Z)">
            <i class="fas fa-undo"></i>
        </button>
        <button class="control-btn" onclick="redoCode()" title="Ø¥Ø¹Ø§Ø¯Ø© (Ctrl+Y)">
            <i class="fas fa-redo"></i>
        </button>
    </div>

    <div class="editor-container">
        <div class="gutter" id="lineNumbers">1</div>
        <div class="editor-wrapper">
            <pre id="highlighting" class="editor-layer"></pre>
            <textarea id="codeEditor" class="editor-layer" spellcheck="false" placeholder="// Ø§ÙƒØªØ¨ ÙƒÙˆØ¯ Ø¨Ø§Ø¨Ù„ Ù‡Ù†Ø§..."></textarea>
        </div>
    </div>

    <div class="shortcut-bar">
        <div class="sc-key" onclick="insert('    ')">Tab</div>
        <div class="sc-key" onclick="insertPair('(', ')')">( )</div>
        <div class="sc-key" onclick="insertPair('[', ']')">[ ]</div>
        <div class="sc-key" onclick="insertPair('{', '}')">{ }</div>
        <div class="sc-key" onclick="insertPair('\'', '\'')">' '</div>
        <div class="sc-key" onclick="insertPair('\"', '\"')">" "</div>
        <div class="sc-key" onclick="insert('=')">=</div>
        <div class="sc-key" onclick="insert(';')">;</div>
        <div class="sc-key" onclick="insert('$')">$</div>
    </div>

    <div id="termView">
        <div class="term-header">
            <span style="color:var(--primary); font-size: 11px;">TERMINAL OUTPUT</span>
            <i class="fas fa-times" onclick="document.getElementById('termView').style.display='none'" style="cursor:pointer; color:var(--error)"></i>
        </div>
        <div id="consoleOutput"></div>
    </div>
</div>

<!-- ğŸ›¡ï¸ Ø§Ù„Ù†ÙˆØ§Ø© Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© (Fallback) -->
<script>
// Fallback Ø¥Ø°Ø§ Ù„Ù… ØªØ­Ù…Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©
if (typeof BabylonCore === 'undefined') {
    window.BabylonCore = {
        execute: async (code, term) => {
            try {
                // Ù…Ø­Ø§ÙƒØ§Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„ØªØ´ØºÙŠÙ„
                term.print("ğŸ”± [BABYLON CORE] Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°...");
                const lines = code.split('\n').filter(l => l.trim());
                for (let line of lines) {
                    if (line.startsWith('say ')) {
                        term.print(line.replace('say ', ''), "#00ff9d");
                    } else if (line.startsWith('var ')) {
                        term.print("âœ… ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ±: " + line, "#ffd700");
                    } else if (line.trim()) {
                        term.print("âš™ï¸ " + line, "#00f2ff");
                    }
                }
                term.print("âœ… ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°!", "#00ff9d");
            } catch (e) {
                term.print("âŒ Ø®Ø·Ø£: " + e.message, "#ff4757");
            }
        },
        checkBalance: async () => {
            return parseInt(localStorage.getItem('babel_credits') || '0');
        },
        consumeCredits: async (amount, reason) => {
            let current = parseInt(localStorage.getItem('babel_credits') || '0');
            if (current >= amount) {
                localStorage.setItem('babel_credits', current - amount);
                return true;
            }
            return false;
        },
        processCommand: async (code, term) => {
            await BabylonCore.execute(code, term);
        }
    };
}

if (typeof SecondaryKernel === 'undefined') {
    window.SecondaryKernel = {
        handleRequest: async (req) => {
            console.log("ğŸ”± [SecondaryKernel] Request:", req.type);
            if (req.type === 'AUTH_USER') {
                localStorage.setItem('babel_credits', '10'); // Ù‡Ø¯ÙŠØ© Ø§Ù„ÙˆÙ„ÙˆØ¬
                return { success: true };
            }
            if (req.type === 'SAVE_FILE') {
                localStorage.setItem('saved_code_' + req.userID, req.content);
                return { success: true };
            }
            if (req.type === 'UPDATE_DAILY_CREDITS') {
                let current = parseInt(localStorage.getItem('babel_credits') || '0');
                localStorage.setItem('babel_credits', current + 10);
                return { success: true };
            }
            return { success: false };
        }
    };
}
</script>

<script>
/**
 * ğŸ”± BABYLON INTERFACE LAYER - [SOVEREIGN EDITION v3.0]
 * Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù…Ø«Ø¨Øª ÙˆØ§Ù„Ù…Ø­Ø³Ù†
 */

// --- 1. Ø¹Ù†Ø§ØµØ± DOM ---
const editor = document.getElementById('codeEditor');
const highlighting = document.getElementById('highlighting');
const gutter = document.getElementById('lineNumbers');
const consoleOutput = document.getElementById('consoleOutput');
const termView = document.getElementById('termView');
const autoPopup = document.getElementById('autocomplete');
const dropdownMenu = document.getElementById('dropdownMenu');
const creditsDisplay = document.getElementById('creditsDisplay');

// ÙƒÙ„Ù…Ø§Øª Ù…ÙØªØ§Ø­ÙŠØ© Ù…Ø­Ø¯Ø«Ø©
const BABEL_KEYWORDS = ['say', 'ask', 'var', 'loop', 'if', 'else', 'build_program', 'wait', 'check', 'stop', 'calc', 'random'];

// --- 2. Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ±Ø§Ø¬Ø¹/Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø© ---
let codeHistory = [];
let historyIndex = -1;
function saveHistory() {
    const code = editor.value;
    if (codeHistory[historyIndex] !== code) {
        codeHistory = codeHistory.slice(0, historyIndex + 1);
        codeHistory.push(code);
        historyIndex++;
        if (codeHistory.length > 50) codeHistory.shift();
    }
}
function undoCode() {
    if (historyIndex > 0) {
        historyIndex--;
        editor.value = codeHistory[historyIndex];
        sync();
    }
}
function redoCode() {
    if (historyIndex < codeHistory.length - 1) {
        historyIndex++;
        editor.value = codeHistory[historyIndex];
        sync();
    }
}

// --- 3. Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡ÙˆÙŠØ© ---
async function unlockGate() {
    const nameInput = document.getElementById('idInput').value.trim();
    const errorDisplay = document.getElementById('gateError');
    
    if (nameInput.length < 3) {
        errorDisplay.innerText = "ğŸš¨ Ø§Ù„Ø§Ø³Ù… Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹!";
        return;
    }

    const finalID = nameInput === "0zasababel" ? "BABEL-1BA" : 'BABEL-' + Math.random().toString(36).substr(2, 6).toUpperCase();

    try {
        const loginResponse = await SecondaryKernel.handleRequest({
            type: 'AUTH_USER',
            username: nameInput,
            userID: finalID
        });

        if (loginResponse && loginResponse.success) {
            localStorage.setItem('babel_access', 'granted');
            localStorage.setItem('babel_username', nameInput);
            localStorage.setItem('babel_id', finalID);
            localStorage.setItem('babel_credits', '10'); // Ù‡Ø¯ÙŠØ© Ø§Ù„ØªØ³Ø¬ÙŠÙ„
            enterSystem(nameInput, finalID);
        } else {
            errorDisplay.innerText = "âŒ ÙØ´Ù„ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©!";
        }
    } catch (e) {
        errorDisplay.innerText = "âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù†ÙˆØ§Ø©: " + e.message;
    }
}

async function enterSystem(name, id) {
    document.getElementById('identityGate').style.display = 'none';
    termView.style.display = 'flex';
    
    await updateCreditsDisplay();
    
    if (name === "0zasababel") {
        document.getElementById('kingBadge').style.display = 'block';
        consoleOutput.innerHTML = `<span style="color:#ffd700">ğŸ”± [SYSTEM] Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚: ${name}</span>\n`;
    } else {
        consoleOutput.innerHTML = `<span style="color:var(--success)">[SYSTEM] Ù…Ø±Ø­Ø¨Ø§Ù‹ ${name} | ID: ${id}</span>\n`;
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­ÙÙˆØ¸
    const saved = localStorage.getItem('saved_code_' + id);
    if (saved) {
        editor.value = saved;
        sync();
        saveHistory();
    }
}

async function updateCreditsDisplay() {
    const currentCr = await BabylonCore.checkBalance();
    creditsDisplay.innerText = currentCr;
}

// --- 4. Ù…Ø­Ø±Ùƒ Ø§Ù„ØªØ­Ø±ÙŠØ± (Ø§Ù„Ù…Ø­Ø³Ù†) ---
let syncTimeout;
editor.addEventListener('input', () => {
    clearTimeout(syncTimeout);
    syncTimeout = setTimeout(() => {
        sync();
        saveHistory();
        checkAutocomplete();
    }, 100); // debounce Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡
});

editor.addEventListener('scroll', () => {
    highlighting.scrollTop = editor.scrollTop;
    highlighting.scrollLeft = editor.scrollLeft;
    gutter.scrollTop = editor.scrollTop;
});

editor.addEventListener('keydown', (e) => {
    // Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¨Ù€ Ctrl+Z
    if (e.ctrlKey && e.key === 'z') {
        e.preventDefault();
        undoCode();
        return;
    }
    // Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù€ Ctrl+Y
    if (e.ctrlKey && e.key === 'y') {
        e.preventDefault();
        redoCode();
        return;
    }
    
    // Tab
    if (e.key === 'Tab') {
        e.preventDefault();
        if (autoPopup.style.display === 'block') {
            const activeItem = autoPopup.querySelector('.auto-item');
            if (activeItem) activeItem.click();
        } else {
            insertText('    ');
        }
        return;
    }

    // Ø£Ù‚ÙˆØ§Ø³ Ø°ÙƒÙŠØ©
    const pairs = { '(': ')', '{': '}', '[': ']', '"': '"', "'": "'" };
    if (pairs[e.key] && !e.ctrlKey && !e.altKey) {
        e.preventDefault();
        const start = editor.selectionStart;
        const end = editor.selectionEnd;
        editor.value = editor.value.substring(0, start) + e.key + pairs[e.key] + editor.value.substring(end);
        editor.selectionStart = editor.selectionEnd = start + 1;
        sync();
        saveHistory();
    }
});

function insertText(text) {
    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    editor.value = editor.value.substring(0, start) + text + editor.value.substring(end);
    editor.selectionStart = editor.selectionEnd = start + text.length;
    sync();
    saveHistory();
}

function insertPair(open, close) {
    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    editor.value = editor.value.substring(0, start) + open + close + editor.value.substring(end);
    editor.selectionStart = editor.selectionEnd = start + 1;
    sync();
    saveHistory();
}

function sync() {
    let code = editor.value;
    let highlighted = code
        .replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
        .replace(/"(.*?)"/g, '<span class="tok-str">"$1"</span>')
        .replace(/\/\/.*/g, '<span class="tok-cmt">$&</span>')
        .replace(/\b(say|ask|var|loop|if|else|build_program|check|wait|stop|calc|random)\b/g, '<span class="tok-kwd">$1</span>')
        .replace(/\$(\w+)/g, '<span class="tok-var">$$$1</span>')
        .replace(/\b(\d+)\b/g, '<span class="tok-num">$1</span>');

    if (code[code.length-1] === "\n") highlighted += " ";
    highlighting.innerHTML = highlighted;
    
    // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø³ÙƒØ±ÙˆÙ„
    highlighting.scrollTop = editor.scrollTop;
    highlighting.scrollLeft = editor.scrollLeft;
    const lines = code.split('\n').length;
    gutter.innerHTML = Array.from({length: lines}, (_, i) => i + 1).join('<br>');
    gutter.scrollTop = editor.scrollTop;
    checkCursorVisibility();
}

// Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ù…Ø¤Ø´Ø±
function checkCursorVisibility() {
    const lineHeight = 24;
    const scrollTop = editor.scrollTop;
    const cursorPos = editor.selectionStart;
    const textBeforeCursor = editor.value.substring(0, cursorPos);
    const currentLine = textBeforeCursor.split('\n').length;
    const cursorTop = (currentLine - 1) * lineHeight;
    
    if (cursorTop < scrollTop) {
        editor.scrollTop = cursorTop;
    } else if (cursorTop + lineHeight > scrollTop + editor.clientHeight) {
        editor.scrollTop = cursorTop + lineHeight - editor.clientHeight + 10;
    }
}

// --- 5. Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Ø§Ù„Ù…Ø­Ø³Ù†) ---
let lastWord = '';
function checkAutocomplete() {
    const cursor = editor.selectionStart;
    const text = editor.value.substring(0, cursor);
    const words = text.split(/[\s\(\)\{\}\[\]]+/);
    lastWord = words[words.length - 1];

    if (lastWord.length >= 1) {
        const matches = BABEL_KEYWORDS.filter(k => k.startsWith(lastWord));
        if (matches.length > 0) {
            showAutocomplete(matches);
        } else {
            hideAutocomplete();
        }
    } else {
        hideAutocomplete();
    }
}

function showAutocomplete(matches) {
    const html = matches.map(m => 
        `<div class="auto-item" onclick="applyAuto('${m}')"><strong>${lastWord}</strong>${m.substring(lastWord.length)}</div>`
    ).join('');
    autoPopup.innerHTML = html;
    autoPopup.style.display = 'block';
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¯Ù‚Ø©
    const textBeforeCursor = editor.value.substring(0, editor.selectionStart);
    const lines = textBeforeCursor.split('\n');
    const currentLine = lines.length;
    const currentLineText = lines[lines.length - 1];
    
    const charWidth = 8.5;
    const lineHeight = 24;
    const gutterWidth = 40;
    const paddingLeft = 15;
    
    const leftPos = gutterWidth + paddingLeft + (currentLineText.length * charWidth) + 5;
    const topPos = (currentLine * lineHeight) - editor.scrollTop + 10;
    
    autoPopup.style.left = Math.min(leftPos, window.innerWidth - 160) + 'px';
    autoPopup.style.top = topPos + 'px';
}

function applyAuto(word) {
    const cursor = editor.selectionStart;
    const before = editor.value.substring(0, cursor - lastWord.length);
    const after = editor.value.substring(cursor);
    editor.value = before + word + " " + after;
    editor.selectionStart = editor.selectionEnd = cursor + (word.length - lastWord.length) + 1;
    hideAutocomplete();
    sync();
    saveHistory();
}

function hideAutocomplete() {
    autoPopup.style.display = 'none';
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¥ÙƒÙ…Ø§Ù„ Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¨Ø±Ø§
document.addEventListener('click', (e) => {
    if (!e.target.closest('#autocomplete') && !e.target.closest('#codeEditor')) {
        hideAutocomplete();
    }
});

// --- 6. Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„Ø¨Ù†Ø§Ø¡ ---
async function buildCode() {
    const userName = localStorage.getItem('babel_username');
    const userID = localStorage.getItem('babel_id');

    const success = await BabylonCore.consumeCredits(1, "BUILD_EXEC");
    if (success) {
        await updateCreditsDisplay();
        termView.style.display = 'flex';
        consoleOutput.innerHTML += `\n<span style="color:#00e5ff">[BUILD]</span> Ø¬Ø§Ø±Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©.. Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${await BabylonCore.checkBalance()} CR\n`;
        await BabylonCore.execute(editor.value, {
            print: (msg, color) => {
                consoleOutput.innerHTML += `<span style="color:${color}">${msg}</span>\n`;
                consoleOutput.scrollTop = consoleOutput.scrollHeight;
            }
        });
    } else {
        alert("âš ï¸ Ø±ØµÙŠØ¯Ùƒ ØºÙŠØ± ÙƒØ§ÙÙ! ØªØ­ØªØ§Ø¬ 1 CR");
    }
}

async function saveCode() {
    const userID = localStorage.getItem('babel_id');
    await SecondaryKernel.handleRequest({
        type: 'SAVE_FILE',
        userID: userID,
        content: editor.value
    });
    alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ù†Ø¬Ø§Ø­!');
    saveHistory();
}

function loadCode() {
    const userID = localStorage.getItem('babel_id');
    const saved = localStorage.getItem('saved_code_' + userID);
    if (saved) {
        if (confirm('ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„Ù…Ø­ÙÙˆØ¸ØŸ Ø³ÙŠÙÙ‚Ø¯ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ.')) {
            editor.value = saved;
            sync();
            saveHistory();
            alert('âœ… ØªÙ… Ø§Ù„ØªØ­Ù…ÙŠÙ„!');
        }
    } else {
        alert('âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø´Ø±ÙˆØ¹ Ù…Ø­ÙÙˆØ¸!');
    }
}

function clearEditor() {
    if (confirm('âš ï¸ Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯ ÙƒØ§Ù…Ù„Ø§Ù‹ØŸ')) {
        editor.value = '';
        sync();
        saveHistory();
    }
}

// --- 7. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§Ù„Ø£Ø­Ø¯Ø§Ø« ---
if(document.getElementById('menuBtn')) {
    document.getElementById('menuBtn').onclick = (e) => {
        e.stopPropagation();
        dropdownMenu.classList.toggle('show');
    };
}
document.addEventListener('click', () => dropdownMenu.classList.remove('show'));

// --- 8. Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ---
setInterval(() => {
    const userID = localStorage.getItem('babel_id');
    if (userID && editor.value) {
        localStorage.setItem('autosave_' + userID, editor.value);
    }
}, 5000); // ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ

// --- 9. Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ---
window.onload = async () => {
    if (localStorage.getItem('babel_access') === 'granted') {
        const savedName = localStorage.getItem('babel_username');
        const savedID = localStorage.getItem('babel_id');
        await enterSystem(savedName, savedID);
    }
    sync();
    saveHistory();
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
    const userID = localStorage.getItem('babel_id');
    if (userID) {
        const autosaved = localStorage.getItem('autosave_' + userID);
        if (autosaved && !editor.value) {
            editor.value = autosaved;
            sync();
            saveHistory();
        }
    }
};
</script>

</body>
</html>
